# RLS (Rate Limit Service) Values - Production Configuration
# Use this file for deploying RLS in production with optimized settings

# Service configuration
service:
  type: ClusterIP
  port: 8082  # Main service port (admin API)
  ports:
    extAuthz: 8080
    rateLimit: 8081
    admin: 8082
    metrics: 9090

# Tenant identification
tenantHeader: "X-Scope-OrgID"

# Limits configuration - Production
# SELECTIVE ENFORCEMENT: Only enforce cardinality limits (per_metric_series_limit and per_user_series_limit)
limits:
  maxRequestBytes: "10485760"  # 10 MiB - Increased for large Alloy payloads
  maxBodyBytes: 0              # 0 = Disabled - No body size enforcement
  failureModeAllow: true       # Production: Allow requests when parsing fails (with intelligent fallback)
  defaultSamplesPerSecond: 1000      # 1000 samples/sec - Enable rate limiting
  defaultBurstPercent: 10      # 10% burst allowance
  enforceBodyParsing: true     # Production: Enable body parsing for cardinality analysis
  defaultMaxLabelsPerSeries: 60      # per_user_series_limit - ENFORCED
  defaultMaxLabelValueLength: 2048   # per_user_series_limit - ENFORCED
  defaultMaxSeriesPerRequest: 10000  # per_metric_series_limit - ENFORCED

# Selective Enforcement Configuration
# Enable cardinality limits AND ingestion rate limiting
enforcement:
  enabled: true
  # Cardinality limits - ENFORCED
  enforceMaxSeriesPerRequest: true   # per_user_series_limit
  enforceMaxSeriesPerMetric: true    # per_metric_series_limit
  enforceMaxLabelsPerSeries: true    # per_labels_per_series_limit
  # Rate limiting - ENABLED
  enforceSamplesPerSecond: true      # Enable ingestion rate limiting
  enforceBytesPerSecond: false       # No bytes rate limiting
  # Body size - DISABLED
  enforceMaxBodyBytes: false         # No body size enforcement

# Store configuration
store:
  backend: "redis"  # memory or redis - Use redis for shared state in production

# Logging configuration - Production
log:
  level: "info"  # Production: Info level for performance
  enableGRPCLogs: false  # Production: Disable gRPC logs for performance
  enableDetailedLogs: false  # Production: Disable detailed logs for performance

# Deployment configuration
replicaCount: 1

image:
  repository: ghcr.io/akshaydubey29/mimir-rls
  tag: "latest-redis-client-arm64"  # Production: Use the Redis client image
  pullPolicy: IfNotPresent  # Production: Use IfNotPresent for efficiency

# Resource configuration - Production
resources:
  limits:
    cpu: 2000m
    memory: 2Gi
  requests:
    cpu: 500m
    memory: 512Mi

# Security context
securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 1000
  capabilities:
    drop:
      - ALL

# Horizontal Pod Autoscaler
hpa:
  enabled: true
  minReplicas: 1
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

# Pod Disruption Budget
pdb:
  enabled: true
  minAvailable: 1

# Service Account
serviceAccount:
  create: true
  annotations: {}

# Pod annotations - Production
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "9090"
  prometheus.io/path: "/metrics"

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity
affinity: {}

# Service Monitor for Prometheus - Production
serviceMonitor:
  enabled: false  # Disable ServiceMonitor for local testing
  scrapeTimeout: 10s
  labels: {}
  annotations: {}

# Redis configuration for shared state
redis:
  # Redis deployment mode
  mode: "external"  # Options: "sidecar" (local per pod) or "external" (shared instance)
  
  # External Redis configuration (when mode: "external")
  external:
    enabled: true  # Set to true to use external Redis
    address: "redis-shared-service.redis-shared.svc.cluster.local:6379"  # External Redis service address
    password: ""  # Redis password if required
    database: 0  # Redis database number
  
  # Sidecar Redis configuration (when mode: "sidecar")
  sidecar:
    enabled: false  # Set to false when using external Redis
    image:
      repository: redis
      tag: "7.2-alpine"
      pullPolicy: IfNotPresent
    resources:
      limits:
        cpu: 500m
        memory: 1Gi
      requests:
        cpu: 100m
        memory: 256Mi
    persistence:
      enabled: true  # Production: Enable persistence for data durability
      size: 10Gi
      storageClass: "standard"  # Production: Use standard storage class (rancher.io/local-path)
      # Alternative storage classes:
      # storageClass: "gp3"  # For AWS
      # storageClass: "fast-ssd"  # For GCP
      # storageClass: "managed-premium"  # For Azure
      # storageClass: ""  # Use default storage class if not specified
    securityContext:
      runAsNonRoot: true
      runAsUser: 999
      fsGroup: 999
    # Production Redis configuration
    config:
      maxmemory: "800mb"
      maxmemoryPolicy: "allkeys-lru"
      appendonly: "yes"
      save: ["900 1", "300 10", "60 10000"]
      timeout: 300
      tcpKeepalive: 300
      # Security settings
      protectedMode: "yes"
      # Performance settings
      tcpBacklog: 511
      databases: 16

# Image pull secrets
imagePullSecrets: []
